The updated code with the windows shell compatibility
